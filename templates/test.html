<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tools - Image Generator and Translator</title>
    <link rel="stylesheet" href="/static/main.css">
</head>
<div class="container">
    <!-- å·¦ä¾§ï¼šç¿»è¯‘åŠŸèƒ½ -->
    <div class="panel left-panel">
        <h2>Text Translator</h2>
        <div class="input-container">
            <textarea id="text-to-translate" placeholder="Enter text to translate"></textarea>
            <button id="translate-button" onclick="translateText()">Translate</button>
        </div>
    </div>

    <!-- å³ä¾§ï¼šå›¾ç‰‡ç”ŸæˆåŠŸèƒ½ -->
    <div class="panel right-panel">
        <h2>DALLÂ·E 3 Image Generator</h2>
        <div class="input-container">
            <button class="record-button" onclick="startRecording()">ğŸ¤ Start Recording</button>
            <textarea id="prompt" placeholder="Enter a description" style="display: none;"></textarea>
            <button id="generate-button" onclick="generateImage()" style="display: none;">Generate</button>            
        </div>
        <div id="result" class="image-result">
            <img src="" alt="Generated Image" style="display: none;">
            <button id="download-button" style="display: none;">Download</button>
        </div>
    </div>
</div>

    

    <script>
        // Image Generator Functions
        async function generateImage() {
            const prompt = document.getElementById('prompt').value.trim();
            const resultContainer = document.getElementById('result');
            resultContainer.textContent = "Generating image...";
        
            if (!prompt) {
                resultContainer.textContent = "Please enter a description!";
                return;
            }
        
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt }),
                });
        
                const result = await response.json();
                if (result.url) {
                    resultContainer.innerHTML = `
                        <img src="${result.url}" alt="Generated Image">
                        <button onclick="downloadImage('${result.url}', 'generated_image.jpg')">Download</button>
                    `;
                } else {
                    resultContainer.textContent = result.error || "Error generating image.";
                }
            } catch (error) {
                console.error("Error generating image:", error);
                resultContainer.textContent = "Network error or server issue.";
            }
        }
        
        function downloadImage(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        

        async function startRecording() {
            try {
                const response = await fetch('/start-recording', {
                    method: 'POST'
                });
                const result = await response.json();
        
                if (result.success) {
                    alert("é–‹å§‹éŒ„éŸ³ï¼Œç•¶æ‚¨åœæ­¢èªªè©±æ™‚æœƒè‡ªå‹•çµæŸéŒ„éŸ³ã€‚");
        
                    // è¼ªè©¢æ©Ÿåˆ¶
                    await pollTranscription();
                } else {
                    alert(result.error || "éŒ„éŸ³å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚");
                }
            } catch (error) {
                console.error("éŒ„éŸ³æ™‚å‡ºéŒ¯ï¼š", error);
                alert("éŒ„éŸ³æ™‚å‡ºéŒ¯ï¼Œè«‹æª¢æŸ¥æ‚¨çš„è¨­ç½®ã€‚");
            }
        }
        
        // è¼ªè©¢å¾Œç«¯ç²å–è½‰éŒ„æ–‡æœ¬
        async function pollTranscription() {
            const maxRetries = 10; // æœ€å¤§é‡è©¦æ¬¡æ•¸
            const interval = 2000; // æ¯æ¬¡é‡è©¦çš„é–“éš”æ™‚é–“ (2ç§’)
            let retryCount = 0;
        
            const resultContainer = document.getElementById('prompt'); // Textarea å…ƒç´ 
            const generateButton = document.getElementById('generate-button'); // æŒ‰éˆ•å…ƒç´ 
            const statusMessage = document.getElementById('status-message'); // ç”¨æ–¼é¡¯ç¤ºç‹€æ…‹çš„å…ƒç´ 
        
            // åˆå§‹åŒ–é€²åº¦æç¤º
            statusMessage.textContent = "æ­£åœ¨ç²å–è½‰éŒ„æ–‡æœ¬...";
            resultContainer.style.display = 'block'; // ç¢ºä¿ textarea å¯è¦‹
            resultContainer.value = ""; // æ¸…ç©º textarea
        
            while (retryCount < maxRetries) {
                try {
                    // ç™¼é€è«‹æ±‚ç²å–è½‰éŒ„çµæœ
                    const transcriptionResponse = await fetch('/transcription', {
                        method: 'GET'
                    });
                    const transcriptionResult = await transcriptionResponse.json();
        
                    if (transcriptionResult.text) {
                        // æˆåŠŸç²å–æ–‡æœ¬ï¼Œé¡¯ç¤ºçµæœ
                        resultContainer.value = transcriptionResult.text;
                        generateButton.style.display = 'block'; // é¡¯ç¤ºç”ŸæˆæŒ‰éˆ•
                        statusMessage.textContent = "è½‰éŒ„å®Œæˆï¼";
                        return; // æˆåŠŸå¾Œé€€å‡ºè¼ªè©¢
                    }
        
                    // æ²’æœ‰æ–‡æœ¬ï¼Œå¢åŠ é‡è©¦æ¬¡æ•¸ä¸¦ç­‰å¾…
                    retryCount++;
                    statusMessage.textContent = `æ­£åœ¨å˜—è©¦ç²å–æ–‡æœ¬...ï¼ˆå˜—è©¦æ¬¡æ•¸ï¼š${retryCount}/${maxRetries}ï¼‰`;
                    await new Promise((resolve) => setTimeout(resolve, interval)); // å»¶é²
                } catch (error) {
                    // è™•ç†ç•°å¸¸æƒ…æ³
                    console.error("è¼ªè©¢è½‰éŒ„æ–‡æœ¬æ™‚å‡ºéŒ¯ï¼š", error);
                    statusMessage.textContent = "ç²å–è½‰éŒ„æ–‡æœ¬æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                    return;
                }
            }
        
            // è¶…å‡ºæœ€å¤§é‡è©¦æ¬¡æ•¸çš„æƒ…æ³
            statusMessage.textContent = "è½‰éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        }
        
        
        
        
        
        async function translateText() {
            const textArea = document.getElementById('text-to-translate');
            const text = textArea.value.trim();
            const targetLanguage = "English";
        
            if (!text) {
                alert('è«‹è¼¸å…¥è¦ç¿»è­¯çš„æ–‡å­—ï¼');
                return;
            }
        
            try {
                // æ˜¾ç¤ºç¿»è¯‘ä¸­çš„çŠ¶æ€
                textArea.value = "æ­£åœ¨ç¿»è­¯ä¸­...";
        
                // å‘èµ·ç¿»è¯‘è¯·æ±‚
                const response = await fetch('/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, target_language: targetLanguage })
                });
        
                const result = await response.json();
        
                if (result.translation) {
                    // æ˜¾ç¤ºç¿»è¯‘ç»“æœ
                    textArea.value = result.translation;
                } else {
                    alert(result.error || 'ç¿»è­¯å¤±æ•—ã€‚');
                    textArea.value = text; // æ¢å¤åŸå§‹æ–‡æœ¬
                }
            } catch (error) {
                console.error('ç¿»è­¯éç¨‹ä¸­å‡ºç¾éŒ¯èª¤ï¼š', error);
                alert('ç¿»è­¯æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
                textArea.value = text; // æ¢å¤åŸå§‹æ–‡æœ¬
            }
        }       

        
    </script>
</body>
</html>
